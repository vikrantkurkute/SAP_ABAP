REPORT ZDOWNLOAD_SMARTFORM_TO_LOCAL.



  PARAMETERS:
  p_path         TYPE rlgrap-filename OBLIGATORY.

DATA:
  gv_path_ini    TYPE string,
  gv_path_sel    TYPE string.


AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_path.

  CALL METHOD cl_gui_frontend_services=>directory_browse
    EXPORTING
      initial_folder  = gv_path_ini
    CHANGING
      selected_folder = gv_path_sel
    EXCEPTIONS
      cntl_error      = 1
      error_no_gui    = 2
      OTHERS          = 3
          .
  IF sy-subrc = 0.
    CALL METHOD cl_gui_cfw=>flush( ).
    IF NOT gv_path_sel IS INITIAL.
      gv_path_ini = p_path = gv_path_sel.
    ENDIF.
  ENDIF.


*  ==============================================================================
  DATA: LV_FORM_NAME      TYPE TDSFNAME VALUE '<FORM_NAME>',
       LV_FMODULE        TYPE RS38L_FNAM,
       LV_CPARAM         TYPE SSFCTRLOP,
       LV_OUTOPTIONS     TYPE SSFCOMPOP,
       LW_SSFCRESCL      TYPE SSFCRESCL.


DATA:W_CPARAM       TYPE SSFCTRLOP,
     W_OUTOPTIONS   TYPE SSFCOMPOP,
     W_BIN_FILESIZE TYPE I, " Binary File Size
     W_FILE_NAME    TYPE STRING,
     W_FULL_PATH    TYPE STRING.


DATA:
*      * Internal table to hold the OTF data
  T_OTF         TYPE ITCOO OCCURS 0 WITH HEADER LINE,

* Internal table to hold OTF data recd from the SMARTFORM
  T_OTF_FROM_FM TYPE SSFCRESCL,

* Internal table to hold the data from the FM CONVERT_OTF
  T_PDF_TAB     LIKE TLINE OCCURS 0 WITH HEADER LINE.
*=============================================================================



  LV_CPARAM-PREVIEW     = SPACE. " Suppressing the dialog box  IMP TO PASS SPACE
  LV_CPARAM-GETOTF  = 'X'.
  LV_CPARAM-NO_DIALOG   = 'X'.


  LV_OUTOPTIONS-TDDEST  = 'LP02'.


  CALL FUNCTION 'SSF_FUNCTION_MODULE_NAME'
    EXPORTING
      FORMNAME           = LV_FORM_NAME
*     VARIANT            = ' '
*     DIRECT_CALL        = ' '
    IMPORTING
      FM_NAME            = LV_FMODULE
    EXCEPTIONS
      NO_FORM            = 1
      NO_FUNCTION_MODULE = 2
      OTHERS             = 3.

  IF SY-SUBRC <> 0.
    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.


  CALL FUNCTION LV_FMODULE "'/1BCDWB/SF00000307'
    EXPORTING
*     ARCHIVE_INDEX      =
*     ARCHIVE_INDEX_TAB  =
*     ARCHIVE_PARAMETERS =
      CONTROL_PARAMETERS = LV_CPARAM
*     CONTROL_PARAMETERS =
*     MAIL_APPL_OBJ      =
*     MAIL_RECIPIENT     =
*     MAIL_SENDER        =
      OUTPUT_OPTIONS     = W_OUTOPTIONS
      USER_SETTINGS      = SPACE                     "IMP TO PASS SAPCE
*      IP_EMP_CODE        = WSALARY-EMP_CODE             "SMARTFORM  INPUT VARIABLES
*      IP_MONTH           = IP_MONTH                      "SMARTFORM  INPUT VARIABLES

    IMPORTING
*     DOCUMENT_OUTPUT_INFO       =
      JOB_OUTPUT_INFO    = T_OTF_FROM_FM  "  ("Internal table to hold OTF data recd from the SMARTFORM)
*     JOB_OUTPUT_OPTIONS =
*    TABLES
*     IT_VBRK            =
*     IT_VBRP            =
    EXCEPTIONS
      FORMATTING_ERROR   = 1
      INTERNAL_ERROR     = 2
      SEND_ERROR         = 3
      USER_CANCELED      = 4
      OTHERS             = 5.
  IF SY-SUBRC <> 0.
* Implement suitable error handling here
  ENDIF.



  REFRESH T_OTF[].
  T_OTF[] = T_OTF_FROM_FM-OTFDATA[].
  CLEAR : W_BIN_FILESIZE.

  CALL FUNCTION 'CONVERT_OTF'
    EXPORTING
      FORMAT                = 'PDF'
      MAX_LINEWIDTH         = 132
*     ARCHIVE_INDEX         = ' '
*     COPYNUMBER            = 0
*     ASCII_BIDI_VIS2LOG    = ' '
*     PDF_DELETE_OTFTAB     = ' '
    IMPORTING
      BIN_FILESIZE          = W_BIN_FILESIZE
*     BIN_FILE              =
    TABLES
      OTF                   = T_OTF
      LINES                 = T_PDF_TAB
    EXCEPTIONS
      ERR_MAX_LINEWIDTH     = 1
      ERR_FORMAT            = 2
      ERR_CONV_NOT_POSSIBLE = 3
      ERR_BAD_OTF           = 4
      OTHERS                = 5.


  CONCATENATE P_PATH  '\'  'WSALARY-EMP_CODE' '_' 'IP_MONTH' '.PDF' INTO W_FULL_PATH.



*** Use the FM GUI_DOWNLOAD to download the generated PDF file onto the
*** presentation server

  CALL FUNCTION 'GUI_DOWNLOAD'
    EXPORTING
      BIN_FILESIZE = W_BIN_FILESIZE
      FILENAME     = W_FULL_PATH
      FILETYPE     = 'BIN'
    TABLES
      DATA_TAB     = T_PDF_TAB.

    BREAK-POINT..
